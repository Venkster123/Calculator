<title> Zhetapi - Calculate </title>

<script>
	MathJax = {
		tex: {
			inlineMath: [['$', '$'], ['\\(', '\\)']]
		}
	};
</script>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<body align="center">
	<h1 align="center" lang="latex">$\Large\mathbf{Zhetapi}$</h1>

	<!-- <hr> -->

	<style>
		input {
			margin: 0;
			padding: 10;
		}

		canvas {
			height: 62%;
			width: 80%;
			margin: 0px;
		}
	</style>

	<form method="POST" align="center">

		<div>
			<input size=60 width=600 name="text" style="height: 100px;">
		</div>

		<div>
			<input type="submit" value="Go" style="margin-top: 10px;
			font-family: 'Courier New', Courier, monospace;">
		</div>

	</form>

	<div vertical layout align="center">

		{% if input %}

		<!-- <hr> -->

		<!-- <h2 align="center"> $\large\mathbf{Result}$ </h2> -->

		<div> ${{input}} = \mathbf{ {{out}} }$ </div>

		{% if date %}

		<div>
			<canvas id="graph" style="border: 2px solid black; margin-top: 10px;"></canvas>

			<script type="text/javascript" language="javascript">

				// Global Variables
				var canvas = document.getElementById("graph");
				var context = canvas.getContext("2d");

				canvas.height = window.innerHeight;
				canvas.width = window.innerWidth;

				var imageData = context.getImageData(0, 0, context.canvas.width, context.canvas.height);
				var rect = canvas.getBoundingClientRect();

				var xhr = new XMLHttpRequest();

				var center = [0, 0];
				var start = [0, 0];

				var clicked = false;

				var dx = 20;
				var dy = 20;

				var pdx = 0;
				var pdy = 0;

				var tdx = 0;
				var tdy = 0;

				// Canvas Listeners
				canvas.addEventListener("mousedown", function (event) {
					canvas.focus();

					imageData = context.getImageData(0, 0, context.canvas.width, context.canvas.height);

					start = [event.clientX - rect.left, event.clientY - rect.top];

					clicked = true;

					pdx = 0;
					pdy = 0;

					tdx = 0;
					tdy = 0;
				}, false);

				canvas.addEventListener("mouseup", function (event) {
					center = [center[0] + tdx, center[1] - tdy];
					clicked = false;

					canvas.style.cursor = "default";

					draw();
				}, false);


				canvas.addEventListener("mousemove", function (event) {
					if (clicked) {
						canvas.style.cursor = "move";

						var x = event.clientX - rect.left;
						var y = event.clientY - rect.top;

						var dx = x - start[0];
						var dy = y - start[1];

						context.putImageData(imageData, dx, dy);

						pdx = dx;
						pdy = dy;

						tdx = dx;
						tdy = dy;

						if (tdx > 0)
							context.clearRect(0, 0, tdx, canvas.height);
						else
							context.clearRect(canvas.width + tdx, 0, Math.abs(tdx), canvas.height);

						if (tdy > 0)
							context.clearRect(0, 0, canvas.width, tdy);
						else
							context.clearRect(0, canvas.height + tdy, canvas.width, Math.abs(tdy));
					}
				}, false);


				canvas.addEventListener("wheel", function (event) {
					console.log("@(x, y): (%g, %g)", event.clientX - rect.left, event.clientY - rect.top);

					if (event.deltaY < 0) {
						dx *= 2;
						dy *= 2;						
					} else {
						dx /= 2;
						dy /= 2;
					}

					draw();
				});

				// Axes and Scale (Ticks) Drawing
				function init() {
					context.beginPath();

					context.moveTo(0, canvas.height / 2 - center[1]);
					context.lineTo(canvas.width, canvas.height / 2 - center[1]);

					context.moveTo(canvas.width / 2 + center[0], 0);
					context.lineTo(canvas.width / 2 + center[0], canvas.height);

					context.strokeStyle = "black";
					context.lineWidth = 2;

					context.stroke();

					context.beginPath();

					var range = canvas.width/dx;

                          		var inc = Math.pow(10, Math.floor(Math.log10(range)) - 1);

					// Minor Ticks (1)
					// var inc = 1;

					for (var i = canvas.width / 2 + center[0] + inc * dx; i < canvas.width; i += inc * dx) {
						context.moveTo(i, 0);
						context.lineTo(i, canvas.height);
					}

					for (var i = canvas.width / 2 + center[0] - inc * dx; i > 0; i -= inc * dx) {
						context.moveTo(i, 0);
						context.lineTo(i, canvas.height);
					}

					for (var i = canvas.height / 2 - center[1] + inc * dx; i < canvas.height; i += inc * dx) {
						context.moveTo(0, i);
						context.lineTo(canvas.width, i);
					}

					for (var i = canvas.height / 2 - center[1] - inc * dx; i > 0; i -= inc * dx) {
						context.moveTo(0, i);
						context.lineTo(canvas.width, i);
					}

					context.lineWidth = 0.5;
					context.strokeStyle = "#c9ccd1";
					context.stroke();

					context.beginPath();

					// Major Ticks (5)

					inc *= 5;

					for (var i = canvas.width / 2 + center[0] + inc * dx; i < canvas.width; i += inc * dx) {
						context.moveTo(i, 0);
						context.lineTo(i, canvas.height);
					}

					for (var i = canvas.width / 2 + center[0] - inc * dx; i > 0; i -= inc * dx) {
						context.moveTo(i, 0);
						context.lineTo(i, canvas.height);
					}

					for (var i = canvas.height / 2 - center[1] + inc * dx; i < canvas.height; i += inc * dx) {
						context.moveTo(0, i);
						context.lineTo(canvas.width, i);
					}

					for (var i = canvas.height / 2 - center[1] - inc * dx; i > 0; i -= inc * dx) {
						context.moveTo(0, i);
						context.lineTo(canvas.width, i);
					}

					context.strokeStyle = "#aaaeb5";
					context.stroke();
				}

				// Pinger (XML Object) Setup
				xhr.onreadystatechange = function () {
					if (xhr.readyState == 4 && xhr.status == 200) {
						lines = xhr.responseText.split("\n");

						canvas.width = canvas.width;

						var i = 0;

						var ppy = canvas.height / 2;
						lines.forEach(function (item) {

							var vals = item.split("\t");

							if (vals) {
								var x = parseFloat(vals[0]);
								var y = parseFloat(vals[1]);

								var px = canvas.width / 2 + (dx * x) + center[0];
								var py = canvas.height / 2 - (dy * y) - center[1];

								if (Math.abs(ppy - py) < canvas.height)
									context.lineTo(px, py);
								else
									context.moveTo(px, py);

								context.strokeStyle = "#00FF00";
								context.stroke();

								ppy = py;
							}

						});

						init();
					}
				}

				// Window Resize Event Handler
				window.onresize = function () {
					canvas.height = window.innerHeight;
					canvas.width = window.innerWidth;

					draw();
				}

				// Drawing (Aux) Function
				function draw() {
					xhr.open('GET', '/graph/{{date}}/{{ftr}}/' + canvas.width / (2 * dx) + '/' + center[0] + '/' + canvas.width / 2);
					xhr.send();
				}

				draw();

			</script>
		</div>

		{% endif %}

		{% endif %}

		<a href="/"><input type="submit" name="session" value="Home" style="margin-top: 50px;
			margin-bottom: 50px; font-family: 'Courier New', Courier, monospace;" align="center"></a>

	</div>

</body>